package com.oxleya.malwareconnector.processor;

import com.auxilii.msgparser.attachment.FileAttachment;
import com.oxleya.malwareconnector.gateway.PushFileForProcessingGateway;
import com.oxleya.malwareconnector.transaction.IntegrationTransactionService;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.scheduling.annotation.Async;
import org.springframework.stereotype.Component;

import javax.annotation.Resource;
import java.io.File;
import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;

@Component
public class EmailAttachmentProcessor {

    private static final Logger LOGGER = LoggerFactory.getLogger(EmailAttachmentProcessor.class);

    @Value("${base.application.folder}")
    private String baseApplicationFolder;

    @Value("${extracted.file.input.folder}")
    private String extractedFileFolder;

    @Resource
    private PushFileForProcessingGateway pushFileForProcessingGateway;

    @Resource
    private IntegrationTransactionService integrationTransactionService;

    /**
     * Primarily pulled out into a separate service so that we can use the async functionality,
     * in order to break the transactional boundary of the original email file that was processed.
     * @param attachment
     * @param savedEmailId
     */
    public void pushAttachmentForProcessing(FileAttachment attachment, Long savedEmailId) {
        try {
            if (Files.notExists(Paths.get(baseApplicationFolder + File.separator + extractedFileFolder))) {
                Files.createDirectories(Paths.get(baseApplicationFolder + File.separator + extractedFileFolder));
            }
            Path newFile = Files.createFile(Paths.get(baseApplicationFolder + File.separator + extractedFileFolder + File.separator + attachment.getLongFilename()));
            Files.write(newFile, attachment.getData());
            pushAttachmentForProcessing(savedEmailId, newFile);
        } catch (IOException e) {
            LOGGER.warn("Unable to write out email attachment to input directory, in order to process the attachment. Attachment was " + attachment.getLongFilename());
            LOGGER.warn("Will move onto any other attachments, nothing more can be done with this one.");
        }
    }

    private void pushAttachmentForProcessing(Long savedEmailId, Path newFile) {
        try {
            pushFileForProcessingGateway.push(newFile.toFile(), savedEmailId);
        } catch (Exception e) {
            try {
                integrationTransactionService.onFailure(newFile.toString());
            } catch (IOException e1) {
                LOGGER.error("An error occurred during processing an attachment. The transaction has also failed to write the file " + newFile.getFileName()+ " to the failure folder.");
            }
            return;
        }
        try {
            integrationTransactionService.onSuccess(newFile.toString());
        } catch (IOException e) {
            LOGGER.error("While processing an attachment, the transaction was not able to successfully complete by writing the file " + newFile.getFileName() + " to the success folder.");
        }
    }
}
